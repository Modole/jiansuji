# Windows 安装包打包说明（PyInstaller + Inno Setup）

本文档说明如何将当前项目打包为可安装的 Windows 桌面应用（含完整运行环境、安装向导、桌面快捷方式和可选签名）。

## 一、准备
- 安装 Python 3.11+（系统已安装可跳过）。
- 安装 Inno Setup 6（用于生成安装包）：https://jrsoftware.org/isinfo.php
- 准备应用图标：将 `assets/app.ico` 替换为您的图标（建议 256x256）。
- 可选：准备代码签名证书（PFX）。

## 二、生成可执行文件（EXE）
在项目根目录打开 PowerShell，执行：

```
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
./build/pack.ps1 -AppName HarmonicTester
```

脚本将：
- 安装 PyInstaller（如未安装）。
- 以 `--onedir` 方式构建 `dist/HarmonicTester/HarmonicTester.exe`，并打包静态资源和数据。
- 如检测到 Inno Setup，将自动编译安装包。

说明：`--onedir` 方案更适合 Flask，静态文件与模板以目录形式分发，避免 `sys._MEIPASS` 路径处理问题。

## 三、生成安装包（含安装向导）
如已安装 Inno Setup，运行上述脚本后将生成：
- `installer/output/HarmonicTesterSetup.exe`

安装包特性：
- 允许用户自定义安装路径（默认 `{localappdata}\HarmonicTester`，无需管理员权限）。
- 提供创建桌面快捷方式选项（“其他选项: 创建桌面快捷方式”）。
- 标准 Windows 安装向导界面（modern 风格）。
- 安装后可在开始菜单和桌面（如勾选）创建快捷方式。
- 写入基本注册表项：`HKCU\Software\HarmonicTester` 记录安装路径与版本。

## 四、运行与兼容性
- 双击 `HarmonicTester.exe` 即可运行应用，内置 Python 运行时与依赖。
- Flask 服务默认监听配置中的 `HOST/PORT`（参见 `app/config.py` 与 `run.py`），可按需修改。
- 在 Windows 10 及以上版本稳定运行。

## 五、图标与版本信息
- EXE 图标来源：`assets/app.ico`。
- 版本信息来源：`build/version_info.txt`，可编辑其中的版本号、公司名、产品名等字段。

## 六、代码签名（可选，提升安全性与可信度）
使用 Windows SDK 的 `signtool.exe` 对 EXE 与安装包签名：

```
# 签名应用 EXE
signtool sign /fd sha256 /tr http://timestamp.digicert.com /td sha256 \
  /f C:\Path\To\cert.pfx /p YourPfxPassword \
  dist\HarmonicTester\HarmonicTester.exe

# 签名安装包
signtool sign /fd sha256 /tr http://timestamp.digicert.com /td sha256 \
  /f C:\Path\To\cert.pfx /p YourPfxPassword \
  installer\output\HarmonicTesterSetup.exe
```

也可在 `installer/HarmonicTester.iss` 中启用自动签名：
- 在 `[SignTool]` 中配置 `mysigntool`。
- 在 `[Setup]` 中取消注释 `SignTool=mysigntool` 与 `SignedUninstaller=yes`。

## 七、部署与数据写入注意事项
- 默认安装到 `{localappdata}`（每用户安装），具备写权限，适合需要写入 `data` 目录与导出文件的场景。
- 若选择安装到 `Program Files`，写入权限受限，建议将运行时数据改用 `{localappdata}` 或 `{commonappdata}`，或修改应用配置以指向可写路径。

## 八、常见问题
- 找不到 `ISCC.exe`：请安装 Inno Setup 6，并确认路径为 `C:\Program Files (x86)\Inno Setup 6\ISCC.exe`，或修改 `build/pack.ps1` 中的 `$ISCC` 路径。
- 静态文件/模板无法加载：请确认使用 `--onedir` 构建，且 `installer` 已复制 `dist/HarmonicTester` 整个目录。
- 端口占用：修改 `app/config.py` 的端口，或在启动前释放占用端口。

## 九、目录与文件清单
- `build/pack.ps1`：一键打包脚本（PyInstaller + Inno Setup）。
- `build/version_info.txt`：EXE 版本资源配置。
- `installer/HarmonicTester.iss`：安装包脚本（路径选择、快捷方式、注册表、签名可选）。
- `assets/app.ico`：应用图标（需自行提供）。

完成以上步骤，即可得到满足需求的安装包与可执行文件。