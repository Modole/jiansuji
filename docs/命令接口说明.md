# 命令下发接口说明（控制测试系统）

本说明定义前端向网关/Node-RED 下发控制命令的协议与建议参数，接口为 `POST http://127.0.0.1:1880/set/data`。

## 一、接口约定
- 方法：POST
- 请求头：`Content-Type: application/json`
- 请求体通用结构：
```json
{
  "command": "start_test",
  "params": {"test_type": "variable_load_accuracy", "load_level": 50, "speed_rpm": 600},
  "addrs": ["ADDR_CMD_START", "ADDR_SET_LOAD_LEVEL", "ADDR_SET_SPEED"]
}
```
- 响应：建议返回
```json
{
  "ok": true,
  "message": "started",
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

说明：`addrs` 为可选，用于指明下发目标地址（来源于通讯地址列表.xlsx），前端通过 `commands-mapping.json` 维护映射，后台可选择忽略或校验。

## 二、命令集合（建议）
- `set_load_level`：设置载荷等级
  - params：`{ "load_level": number }`（0-100）
  - addrs：`ADDR_SET_LOAD_LEVEL`
- `set_speed_rpm`：设置转速（rpm）
  - params：`{ "speed_rpm": number }`
  - addrs：`ADDR_SET_SPEED`
- `start_test`：开始测试
  - params：`{ "test_type": string }`，取值：
    - `start_torque`、`no_load_accuracy`、`variable_load_accuracy`、`peak_load_accuracy`、`efficiency`、`noise`
  - addrs：`ADDR_CMD_START`
- `stop_test`：停止测试
  - params：`{ "test_type": string }`
  - addrs：`ADDR_CMD_STOP`
- `emergency_stop`：急停
  - params：`{}`
  - addrs：`ADDR_CMD_ESTOP`
- `reset`：复位
  - params：`{ "scope": "static" | "dynamic" | "all" }`
  - addrs：`ADDR_CMD_RESET`
- `sample_static`：静态采样一次（触发一次测量）
  - params：`{ "keys": [ ... ] }`（可选）
  - addrs：`ADDR_CMD_SAMPLE_STATIC`

## 三、与点位表的关系
- 新增配置文件：`webapp/config/commands-mapping.json`
- 作用：将命令与通讯地址映射，实际地址请参考《通讯地址列表.xlsx》填写。
- 占位示例：
```json
{
  "set_load_level": "ADDR_SET_LOAD_LEVEL",
  "set_speed_rpm": "ADDR_SET_SPEED",
  "start_test": "ADDR_CMD_START",
  "stop_test": "ADDR_CMD_STOP",
  "emergency_stop": "ADDR_CMD_ESTOP",
  "reset": "ADDR_CMD_RESET",
  "sample_static": "ADDR_CMD_SAMPLE_STATIC"
}
```

## 四、前端交互与回显
- 下发成功后弹出 Toast 提示并自动刷新对应页面数据；
- 开始测试时自动开启动态页面的自动刷新；停止测试时自动关闭；
- 急停/复位同样弹出状态提示。

## 五、注意事项
- CORS：请在后台允许来源 `http://127.0.0.1:5500`。
- 安全：生产环境建议增加鉴权与幂等；命令执行需考虑状态机与互斥关系（如正在测试时禁止再次 start）。
- 日志：前端可选记录最近 N 次命令及响应用于审计。